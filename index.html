<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add to Calendar</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; padding: 40px 20px; background: #f4f7f9; color: #333; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 380px; margin: auto; }
        h2 { margin: 0 0 8px 0; color: #000; font-size: 24px; }
        .date-display { color: #666; font-size: 18px; margin-bottom: 5px; font-weight: 500; }
        .time-display { color: #888; font-size: 16px; margin-bottom: 25px; }
        .btn { display: block; padding: 16px; margin: 12px 0; border-radius: 12px; text-decoration: none; font-weight: bold; color: white; font-size: 16px; }
        .outlook { background: #0078d4; }
        .google { background: #34a853; }
        .default { background: #555; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title">New Event</h2>
        <div id="dateRow" class="date-display">Date of Event</div>
        <div id="timeRow" class="time-display">Time of Event</div>
        <p id="locRow" style="color: #666; margin-bottom: 20px;">Location TBD</p>
        
        <a id="outLink" class="btn outlook" href="#">Add to Outlook</a>
        <a id="gooLink" class="btn google" href="#">Add to Google</a>
        <a id="icsLink" class="btn default" href="#">Add to Default Calendar</a>
    </div>

<script>
    (function() {
        // Prevent Safari BFCache glitches
        window.onpageshow = function(event) {
            if (event.persisted) window.location.reload();
        };

        const p = new URLSearchParams(window.location.search);
        const title = p.get('t') || "New Event";
        const s = p.get('s') || ""; 
        const e = p.get('e') || "";
        const l = p.get('l') || "Location TBD";
        const isAllDay = p.get('allday') === 'true';

        document.getElementById('title').innerText = title;
        document.getElementById('locRow').innerText = "ðŸ“ " + l;

        // NEW: DST-Aware Offset (Calculates for the actual event date)
        function offsetForDate(y, m, d) {
            const dt = new Date(y, m - 1, d);
            const o = -dt.getTimezoneOffset();
            const sign = o >= 0 ? '+' : '-';
            const hh = String(Math.floor(Math.abs(o) / 60)).padStart(2, '0');
            return `${sign}${hh}:00`;
        }

        // Refined Outlook ISO (RFC 3339 with Correct Local Offset)
        function toOutlookISO(ts, allDay) {
            const y = ts.substring(0,4);
            const m = ts.substring(4,6);
            const d = ts.substring(6,8);
            const tz = offsetForDate(parseInt(y), parseInt(m), parseInt(d));

            if (allDay || ts.length < 9) {
                return `${y}-${m}-${d}T00:00:00${tz}`;
            }

            const h = ts.substring(9,11);
            const min = ts.substring(11,13);
            return `${y}-${m}-${d}T${h}:${min}:00${tz}`;
        }

        if (s) {
            const yr = s.substring(0,4);
            const moIdx = parseInt(s.substring(4,6)) - 1;
            const dy = s.substring(6,8);
            const dObj = new Date(yr, moIdx, dy);
            
            document.getElementById('dateRow').innerText = dObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            function fmt(ts) {
                if (ts.length < 9) return ""; 
                let h = parseInt(ts.substring(9,11));
                let m = ts.substring(11,13);
                let a = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return h + ":" + m + " " + a;
            }

            document.getElementById('timeRow').innerText = isAllDay ? "All Day Event" : (fmt(s) + (e ? " - " + fmt(e) : ""));

            const sISO = toOutlookISO(s, isAllDay);
            const eISO = e ? toOutlookISO(e, isAllDay) : sISO;

            // 1. Outlook: Production-grade RFC 3339 + live.com endpoint
            const outParams = new URLSearchParams({
                subject: title,
                location: l,
                startdt: sISO,
                enddt: eISO
            });
            if (isAllDay) outParams.append('allday', 'true');
            document.getElementById('outLink').href = "https://outlook.live.com/calendar/0/deeplink/compose?" + outParams.toString();

            // 2. Google: URL Encoded for consistency
            const gooParams = new URLSearchParams({
                action: 'TEMPLATE',
                text: title,
                dates: (isAllDay ? s.substring(0,8) + "/" + (e.substring(0,8) || s.substring(0,8)) : s + "/" + (e || s)),
                location: l
            });
            document.getElementById('gooLink').href = "https://calendar.google.com/calendar/render?" + gooParams.toString();

            // 3. Apple/ICS: Standardized datetime format (adds seconds)
            const icsData = isAllDay ? 
                `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:${title}\nDTSTART;VALUE=DATE:${s.substring(0,8)}\nDTEND;VALUE=DATE:${e.substring(0,8) || s.substring(0,8)}\nLOCATION:${l}\nX-MICROSOFT-CDO-ALLDAYEVENT:TRUE\nEND:VEVENT\nEND:VCALENDAR` :
                `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:${title}\nDTSTART:${s}00\nDTEND:${(e || s)}00\nLOCATION:${l}\nEND:VEVENT\nEND:VCALENDAR`;
            
            document.getElementById('icsLink').href = "data:text/calendar;charset=utf8," + encodeURIComponent(icsData);
            
        } else {
            document.getElementById('dateRow').innerText = "Event Details Missing";
            document.getElementById('timeRow').innerText = "Please regenerate your link";
        }
    })();
</script>
</body>
</html>
