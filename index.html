<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add to Calendar</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; padding: 40px 20px; background: #f4f7f9; color: #333; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 380px; margin: auto; }
        h2 { margin: 0 0 8px 0; color: #000; font-size: 24px; }
        .date-display { color: #666; font-size: 18px; margin-bottom: 5px; font-weight: 500; }
        .time-display { color: #888; font-size: 16px; margin-bottom: 25px; }
        .btn { display: block; padding: 16px; margin: 12px 0; border-radius: 12px; text-decoration: none; font-weight: bold; color: white; font-size: 16px; }
        .outlook { background: #0078d4; }
        .google { background: #34a853; }
        .default { background: #555; }
        .note { font-size: 12px; color: #999; margin-top: 15px; font-style: italic; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title">New Event</h2>
        <div id="dateRow" class="date-display"></div>
        <div id="timeRow" class="time-display"></div>
        <p id="locRow" style="color: #666; margin-bottom: 20px;"></p>
        
        <a id="outLink" class="btn outlook" href="#" target="_blank">Add to Outlook</a>
        <a id="gooLink" class="btn google" href="#" target="_blank">Add to Google</a>
        <a id="icsLink" class="btn default" href="#">Add to Default Calendar</a>
        <p class="note">Note: You may be asked to sign in to your Microsoft account.</p>
    </div>

<script>
    (function() {
        const p = new URLSearchParams(window.location.search);
        const title = p.get('t') || "New Event";
        // Default to a future date so it's obvious if data is missing
        const s = p.get('s') || "20260203T160000"; 
        const e = p.get('e') || "20260203T170000";
        const l = p.get('l') || "Location TBD";
        const isAllDay = p.get('allday') === 'true';

        // --- Visual Display Logic ---
        const yr = s.substring(0,4);
        const mo = parseInt(s.substring(4,6)) - 1;
        const dy = s.substring(6,8);
        const dObj = new Date(yr, mo, dy);

        document.getElementById('title').innerText = title;
        document.getElementById('locRow').innerText = "üìç " + l;
        document.getElementById('dateRow').innerText = dObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        function fmt(ts) {
            if (ts.length < 9) return ""; 
            let h = parseInt(ts.substring(9,11));
            let m = ts.substring(11,13);
            let a = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return h + ":" + m + " " + a;
        }
        document.getElementById('timeRow').innerText = isAllDay ? "All Day Event" : (fmt(s) + (e ? " - " + fmt(e) : ""));

        // --- ISO Formatting Helpers ---
        function toIsoString(ts) {
            return ts.substring(0,4) + "-" + ts.substring(4,6) + "-" + ts.substring(6,8) + "T" + ts.substring(9,11) + ":" + ts.substring(11,13) + ":00";
        }
        const sISO = toIsoString(s);
        const eISO = e ? toIsoString(e) : sISO;

        // --- 1. Outlook Link ---
        const outParams = new URLSearchParams({
            path: '/calendar/action/compose',
            rru: 'addevent',
            startdt: sISO,
            enddt: eISO,
            subject: title,
            location: l
        });
        if (isAllDay) outParams.append('allday', 'true');
        document.getElementById('outLink').href = "https://outlook.office.com/owa/?" + outParams.toString();

        // --- 2. Google Link ---
        const gooParams = new URLSearchParams({
            action: 'TEMPLATE',
            text: title,
            dates: (isAllDay ? s.substring(0,8) + "/" + (e.substring(0,8) || s.substring(0,8)) : s + "/" + (e || s)),
            location: l
        });
        document.getElementById('gooLink').href = "https://calendar.google.com/calendar/render?" + gooParams.toString();

        // --- 3. Default Calendar (ICS) ---
        // Generate a deterministic UID so re-adding the event updates it instead of duplicating it
        const simpleUID = s + "-" + title.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20) + "@myapp";
        
        const icsData = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//My Calendar App//EN",
            "BEGIN:VEVENT",
            "UID:" + simpleUID,
            "SUMMARY:" + title,
            isAllDay 
                ? "DTSTART;VALUE=DATE:" + s.substring(0,8) + "\r\nDTEND;VALUE=DATE:" + (e.substring(0,8) || s.substring(0,8))
                : "DTSTART:" + s + "\r\nDTEND:" + e,
            "LOCATION:" + l,
            "END:VEVENT",
            "END:VCALENDAR"
        ].join("\r\n");

        const icsUrl = "data:text/calendar;charset=utf8," + encodeURIComponent(icsData);
        const icsBtn = document.getElementById('icsLink');
        icsBtn.href = icsUrl;

        // --- 4. The IOS vs Desktop Switch ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        if (!isIOS) {
            // Desktop/Android: Needs download attribute to save file
            icsBtn.setAttribute("download", title.replace(/[^a-zA-Z0-9]/g, '_') + ".ics");
        }
        // iOS: Needs NO download attribute (handled by href alone)
    })();
</script>
</body>
</html>
